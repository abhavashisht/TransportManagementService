<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Book a Seat</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .seat {
      width: 40px; height: 40px;
      border: 1px solid #ccc;
      border-radius: 5px;
      cursor: pointer;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 0.8rem;
    }
    .seat.available { background-color: #d4edda; color: #155724; }
    .seat.booked { background-color: #f8d7da; color: #721c24; cursor: not-allowed; }
    .seat.selected { background-color: #0d6efd; color: white; border-color: #0d6efd;}
  </style>
</head>
<body class="bg-light">
<div class="container py-5">
  <div class="row justify-content-center">
    <div class="col-md-8">
      <div class="card shadow">
        <div class="card-header">
          <h4 id="route-title">Select a Seat</h4>
        </div>
        <div class="card-body">
          <p>Please select an available seat from the grid below.</p>
          <div id="seat-grid" class="d-flex flex-wrap gap-2 justify-content-center mb-4 p-3 bg-light border rounded">
          </div>
          <div id="booking-info" class="text-center">
            <p>Selected Seat: <strong id="selected-seat-text">None</strong></p>
            <button id="confirm-btn" class="btn btn-success" onclick="bookSeat()" disabled>Confirm Booking</button>
            <div id="msg" class="mt-3"></div>
          </div>
          <div class="mt-4">
            <a href="search.html">&laquo; Back to Routes</a>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
<script>
  const urlParams = new URLSearchParams(window.location.search);
  const routeId = urlParams.get('routeId');
  const capacity = parseInt(urlParams.get('capacity'));
  const source = urlParams.get('from');
  const destination = urlParams.get('to');

  const token = localStorage.getItem('jwt');
  let selectedSeat = null;

  // Redirect if not logged in or missing params
  if (!token || !routeId) {
    window.location.href = 'index.html';
  }

  document.getElementById('route-title').innerText = `Select a Seat for ${source} â†’ ${destination}`;

  async function generateSeatGrid() {
    const grid = document.getElementById('seat-grid');
    grid.innerHTML = '<div class="spinner-border"></div>'; // Show loader

    // Fetch booked seats
    const bookedRes = await fetch(`/tickets/booked-seats/${routeId}`, {
        headers: { 'Authorization': 'Bearer ' + token }
    });
    const bookedSeats = await bookedRes.json();
    grid.innerHTML = ''; // Clear loader

    for (let i = 1; i <= capacity; i++) {
      const seatEl = document.createElement('div');
      const seatNum = `S${i}`;
      seatEl.innerText = seatNum;
      seatEl.classList.add('seat');

      if (bookedSeats.includes(seatNum)) {
        seatEl.classList.add('booked');
      } else {
        seatEl.classList.add('available');
        seatEl.onclick = () => selectSeat(seatEl, seatNum);
      }
      grid.appendChild(seatEl);
    }
  }

  function selectSeat(element, seatNum) {
      // Deselect previous
      const currentSelected = document.querySelector('.seat.selected');
      if(currentSelected) {
          currentSelected.classList.remove('selected');
      }

      // Select new one
      element.classList.add('selected');
      selectedSeat = seatNum;

      // Update UI
      document.getElementById('selected-seat-text').innerText = selectedSeat;
      document.getElementById('confirm-btn').disabled = false;
  }

  async function bookSeat() {
      if (!selectedSeat) {
          alert('Please select a seat first.');
          return;
      }
      const msgEl = document.getElementById('msg');
      msgEl.innerHTML = '';
      document.getElementById('confirm-btn').disabled = true;

      try {
        const res = await fetch('/tickets', {
            method: 'POST',
            headers: {'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token},
            body: JSON.stringify({ routeId: Number(routeId), seatNo: selectedSeat })
        });

        if (!res.ok) {
            const err = await res.json();
            throw new Error(err.error || "Booking failed.");
        }

        const data = await res.json();
        window.location.href = `confirm.html?ticketId=${data.id}`;

      } catch (e) {
        msgEl.innerHTML = `<div class="alert alert-danger">${e.message}</div>`;
        document.getElementById('confirm-btn').disabled = false;
        generateSeatGrid(); // Refresh grid in case a seat was taken
      }
  }

  document.addEventListener('DOMContentLoaded', generateSeatGrid);
</script>
</body>
</html>